name: Release Nearby QML Tray App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  FORCE_COLOR: true

permissions:
  contents: write

jobs:
  build-and-release-linux:
    name: Build and Release Linux Bundle
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set up Bazelisk
        uses: bazel-contrib/setup-bazel@0.18.0
        with:
          # Avoid downloading Bazel every time.
          bazelisk-cache: true
          # Store build cache per workflow.
          disk-cache: ${{ github.workflow }}
          # Share repository cache between workflows.
          repository-cache: true

      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: apt-${{ runner.os }}-${{ hashFiles('.github/workflows/release-nearby-qml-tray.yaml') }}
          restore-keys: apt-${{ runner.os }}-
          save-always: true

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libsdbus-c++-dev \
            libssl-dev \
            libsystemd-dev \
            libcurlpp-dev \
            libasound2-dev \
            libunistring-dev \
            libldap-dev \
            libkrb5-dev \
            libgpg-error-dev \
            libbluetooth-dev \
            libxkbcommon-dev \
            patchelf \
            qt6-base-dev \
            qt6-declarative-dev \
            qt6-tools-dev \
            qt6-tools-dev-tools

      - name: Build and install Nearby shared library
        id: nearby
        run: |
          INSTALL_PREFIX="$RUNNER_TEMP/nearby-install"
          bazel build \
            --check_visibility=false \
            --spawn_strategy=standalone \
            --verbose_failures \
            --cxxopt=-std=c++20 \
            --host_cxxopt=-std=c++20 \
            --@com_google_protobuf//bazel/toolchains:prefer_prebuilt_protoc=true \
            --copt='-DGITHUB_BUILD' \
            //sharing/linux:nearby_connections_service_linux_shared
          BAZEL_BIN="$(bazel info bazel-bin)"
          install -d "$INSTALL_PREFIX/lib"
          install -d "$INSTALL_PREFIX/include/sharing/linux"
          install -m 0755 "$BAZEL_BIN/sharing/linux/libnearby_connections_service_linux_shared.so" "$INSTALL_PREFIX/lib/"
          patchelf --set-soname libnearby_connections_service_linux_shared.so "$INSTALL_PREFIX/lib/libnearby_connections_service_linux_shared.so"
          install -m 0644 "sharing/linux/nearby_connections_qt_facade.h" "$INSTALL_PREFIX/include/sharing/linux/"
          echo "nearby_prefix=$INSTALL_PREFIX" >> "$GITHUB_OUTPUT"

      - name: Configure QML tray app
        run: |
          cmake -S sharing/linux/qml_tray_app \
                -B sharing/linux/qml_tray_app/build \
                -DCMAKE_BUILD_TYPE=Release \
                -DNEARBY_INSTALL_PREFIX="${{ steps.nearby.outputs.nearby_prefix }}"

      - name: Build QML tray app
        run: cmake --build sharing/linux/qml_tray_app/build -j

      - name: Package release bundle
        run: |
          cd sharing/linux/qml_tray_app/build
          cpack -G ZIP

      - name: Generate SHA256 checksum
        run: |
          cd sharing/linux/qml_tray_app/build
          sha256sum nearby_qml_tray_app-Linux-x86_64.zip > nearby_qml_tray_app-Linux-x86_64.zip.sha256

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: nearby_qml_tray_app-Linux-x86_64
          path: |
            sharing/linux/qml_tray_app/build/nearby_qml_tray_app-Linux-x86_64.zip
            sharing/linux/qml_tray_app/build/nearby_qml_tray_app-Linux-x86_64.zip.sha256

      - name: Publish GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            sharing/linux/qml_tray_app/build/nearby_qml_tray_app-Linux-x86_64.zip
            sharing/linux/qml_tray_app/build/nearby_qml_tray_app-Linux-x86_64.zip.sha256
